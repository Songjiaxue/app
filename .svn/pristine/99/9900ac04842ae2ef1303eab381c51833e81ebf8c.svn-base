;~function () {

    var app = function () {
        this.nav = $('.nav-item');
        this.navGroup = $('[data-selector="nav"]');
        this.title = $('[data-selector="title"]');
        //数据加载的选择器
        this._up_nav = $('[data-selector="up-nav-group"]');
        this.my_up_nav = $('[data-selector="my-up-nav-group"]');
        this.columnApi = 'bbs/Article/column';
        this.bbsPageGroup;
        //内容选择器
        this.officialContext = $('[data-selector="official-context"]');
        this.page = 1;
        this.size = 10;
        this.load = $('._load');
        this.loading = $('._loading');
        this._undefined = $('._undefined');
        //details
        this.detailsContext = $('[data-selector="details-context"]');
        this.assessContext = $('[data-selector="assess-context"]');
        //执行
    };
    app.prototype.init = function () {
        var self = this;
        async.waterfall([
            function ( cb ) {
                self.getColumn( cb );
            },
            function ( ret , cb ) {
                self.resetBbsPageGroup(ret,cb);
            },
            function (ret , cb) {
                self.appendColumn( ret , cb);
            }
        ],function (err , ret) {
            self.switchNav();
            self.resetNav();
        });
    };
    /**
     * 获得bbs-column
     * @param cb
     */
    app.prototype.getColumn = function (callback) {
        var self = this;
        callback = typeof callback == 'function' ? callback : function () {};
        $.ajax({
            url : self.columnApi
        }).then(callback)
    };
    app.prototype.columnHtml = function (db) {
        var html = '';
        db.forEach(function (item , i) {
            if(i == 0) {
                html += '<div class="nav-item active" data-event="bbsSwitchGroup" data-params="';
            }else{
                html += '<div class="nav-item" data-event="bbsSwitchGroup" data-params="';
            };
            html += i;
            html += '">';
            html += item.name;
            html += '</div>';
        });
        return html;
    };
    app.prototype.appendColumn =function (db , cb) {
        var self = this;
        self._up_nav.html( self.columnHtml(db) );
        cb(null);
    };

    app.prototype.resetBbsPageGroup = function (db , cb) {
        var self = this;
        db = typeof db.data.info != 'undefined' ? db.data.info : [];
        self.bbsPageGroup = [];
        //热点页面
        db.forEach(function (item , i) {
            self.bbsPageGroup.push({
                name: 'bbs-' + i,
                url: 'widget://html/bbs/bbs-official.html',
                bgColor : '#f2f2f2',
                vScrollBarEnabled: false,
                hScrollBarEnabled: false,
                customRefreshHeader: 'UIPullRefresh',
                bounces: true,
                pageParam :{
                    id : item.id
                }
            });
        });
        //姐妹说页面
        for (var i = 0 ; i < 4 ; i++){
            self.bbsPageGroup.push({
                name: 'bbs-' + ( db.length + i ),
                url: 'widget://html/bbs/bbs-other.html',
                customRefreshHeader: 'UIPullRefresh',
                bounces: true,
                bgColor : '#f2f2f2',
                vScrollBarEnabled: false,
                hScrollBarEnabled: false,
                pageParam :{
                    id : i
                }
            });
        };
        //发送事件，修改bbs页面内容
        $.api.sendEvent('changeBbsPageGroup' , {
            pageGroup : self.bbsPageGroup
        });

        cb(null, db);
    };
    app.prototype.resetNav = function () {
        var self = this;
        //重设姐妹说
        self.title.eq(1).data('params', self.bbsPageGroup.length - 4 );
        //重设姐妹说内容
        var item = self.my_up_nav.find('.nav-item');
        for (var i = 0 ; i < item.length; i++){
            item.eq(i).data('params' , self.bbsPageGroup.length - 4 + i );
        };
        self.nav = $('.nav-item');
    };
    app.prototype.switchNav = function () {
        var self = this;
        $.api.listenerEvent('bbsSwitchNav' , function (ret) {
            self.switchNavItem(ret.index);
        });
    };
    app.prototype.switchNavItem = function (i) {
        var self = this;
        var navNum = self.navGroup.eq(0).find('.nav-item').length;
        self.nav.removeClass('active').eq(i).addClass('active');
        self.navGroup.removeClass('show');
        self.title.removeClass('active');
        i = Math.floor(i / navNum);
        self.navGroup.eq(i).addClass('show');
        self.title.eq(i).addClass('active');
    };
    app.prototype.sendEvent = function (i) {
        var self = this;
        $.api.sendEvent('bbsSwitchGroup' ,{
            index : i
        });
    };
    $.homeBbs = function () {
        return new app();
    };
}();
;~function () {

    var app = function () {
        this.$city = $('[data-selector="city-name"]');
        this.$topAds = $('[data-selector="top-ads"]');
        this.$plateAds = $('[data-selector="plate-ads"]');
        this.$bill = $('[data-selector="bill-ads"]');
        this.$beauty = $('[data-selector="beauty"]');
        this.$loadMore = $('._load-more');
        this.page = 1;
        this.size = 10;
        this.scroll = $.scroll();
        this.bMap = $.bMap();
    };
    app.prototype.init = function () {
        var self = this;
        // todo : 调取bMap , 获得当前位置，如果获取失败提示用户选择地区
        self.bMap.city(function ( err , ret ) {
            // 出现错误
            if(!!err) {
                var $f = confirm('定位失败 : 请手动选择地区或者给予我们获取地理位置权限，为您提供更好的服务');
                if($f) $.app.switch('openNewWin' , {
                    name : 'win_city_lists'
                });
            };
            // 重设地区信息
            self.cityTips(err , ret);

            // 首页大广告
            self.top_ads(1);

            // 品牌推荐
            self.plate_ads(2);

            //同城推荐
            self.bill_ads(3);

            //Main
            self.main();
        });
    };
    /**
     * todo ：主入口
     */
    app.prototype.main = function () {
        var self = this;
        self.page = 1;
        self.beauty();
    };

    /**
     * todo : 修改首页提示，刷新本地缓存
     * @param ret
     * @param callback
     */
    app.prototype.cityTips = function (err , ret) {
        var self = this;
        self.$city.text( !!err ? '未知' : ret.city.city );
        self.bMap.cache(err,ret);
    };
    /**
     * todo : 首页最上面的广告
     */
    app.prototype.top_ads = function ( id ) {
        var self = this;
        async.waterfall([
            function (cb) {
                self.ajax_ads(id , cb);
            },
            function (ret , cb) {
                self.ads_html(ret , cb);
            }
        ],function (err ,ret) {
            $.app.swipe();
        });
    };
    /**
     * todo : 品牌推荐的广告
     * @param id
     * @param callback
     */
    app.prototype.plate_ads = function (id ) {
        var self = this;
        async.waterfall([
            function (cb) {
                self.ajax_ads(id , cb);
            },
            function (ret , cb) {
                self.plate_html(ret , cb);
            }
        ],function (err ,ret) {
            $.echo();
        });
    };
    /**
     * todo : 同城推荐广告
     * @param id
     * @param callback
     */
    app.prototype.bill_ads = function ( id) {
        var self = this;
        async.waterfall([
            function (cb) {
                self.ajax_ads(id , cb);
            },
            function (ret , cb) {
                self.bill_html(ret , cb);
            }
        ],function (err ,ret) {
            $.echo();
        });
    };
    /**
     * todo : 获得广告数据
     * @param ret
     * @param callback
     */
    app.prototype.ajax_ads = function ( id  , callback) {
        var self = this,
            city = JSON.parse(localStorage.city);
        $.ajax({
            url : 'ads/index/index',
            data :　{
                area : typeof city == 'object' ? city.city.id : 0,
                position : id
            }
        }).then(callback);
    };
    /**
     * todo : 获得top广告部分的html
     * @param ret
     * @param callback
     */
    app.prototype.ads_html = function (ret , callback) {
        var self = this;
        self.$topAds.html( $.ads.html(ret) );
        callback();
    };
    /**
     * todo : 品牌推荐部分的广告
     * @param ret
     * @param callback
     */
    app.prototype.plate_html = function (ret , callback) {
        var self = this;
        var html = $.ads.plate_html(ret);
        self.$plateAds.html( html );
        callback();
    };
    /**
     * todo : 同城推荐的广告
     * @param ret
     * @param callback
     */
    app.prototype.bill_html = function (ret , callback) {
        var self = this;
        var html = $.ads.bill_html(ret);
        self.$bill.html( html );
        callback();
    };
    app.prototype.beauty = function () {
        var self = this;
        self.scroll.removeListenerToBottom();
        async.waterfall([
            function (cb) {
                self.ajax(cb);
            },
            function ( ret , cb) {
                self.beauty_html(ret ,cb);
            },
            function (ret ,cb) {
                self.iScroll( ret , cb);
            }
        ],function (err) {
            $.echo();
            if(err) return $.api.toast(err);
            self.page += 1;
        });
    };
    app.prototype.iScroll = function (ret , callback) {
        var self = this;
        callback = $.callback(callback);
        if( !ret.data.info || ret.data.info.length < self.size ) {
            self.$loadMore.text('后面没有了')
            return callback();
        };
        self.$loadMore.text('努力加载中');
        self.scroll.addListenerToBottom(function () {
            self.beauty();
        });
        callback();
    };
    app.prototype.ajax = function (callback) {
        var self = this;
        callback = $.callback(callback);
        var city = JSON.parse(localStorage.city),
            data = {
                longitude : typeof city == 'object' ? city.lon : 0,
                latitude : typeof city == 'object' ? city.lat : 0,
                page : self.page ,
                size : self.size
            };
        $.ajax({
            url : 'mall/shop/list',
            data : data
        }).then(callback)
    };
    app.prototype.beauty_html = function (ret , callback) {
        var self = this;
        callback = $.callback(callback);
        self.page == 1 ? self.$beauty.html(self.html(ret)) : self.$beauty.append(self.html(ret));
        callback(null, ret);
    };
    app.prototype.html = function (ret) {
        if(typeof ret != 'object' || typeof ret.data == typeof void 0 || ret.data.info == typeof void 0) return '';
        var self = this,
            html = '',
            db = ret.data.info,
            city = JSON.parse(localStorage.city);
        html = '<div class="list-group">';
        db.forEach(function (beauty) {
            html += '<div class="list-item" data-event="openNewWin" data-params=\'{"name":"win_beauty_home","param":{"id":"';
            html += beauty.id;
            html += '"}}\'><div class="list-item-left" data-echo-background="';
            html += beauty.logo;
            html += '"></div><div class="list-item-right"><div class="list-item-title"><p>';
            html += beauty.name;
            html += '</p></div><div class="list-item-info">';
            html += beauty.description;
            html += '</div><div class="list-item-addr"><div class="addr-left">';
            //html += typeof city === 'object' ? '【' + city.city.city + '】' :'';
            html += '【地址】';
            html += beauty.address;
            html += '</div><div class="addr-right"><i class="icon-place"></i><span>&lt;';
            html += beauty.distance < 0 ? Math.floor( beauty.distance * 1000) + 'm' : Math.floor( beauty.distance) + 'km';
            html += '</span></div></div><div class="list-item-review">';
            for(var i = 1 ; i < 6 ; i++){
                i <= beauty.star ? html += '<i class="icon-star active"></i>' : html += '<i class="icon-star"></i>';
            };
            html += '<span>';
            html += beauty.bbs_count || 0;
            html += '人评价</span></div></div></div>';
        });
        html += '</div>';
        return html;
    };
    return $.homeIndex = function () {
        return new app();
    };
}();
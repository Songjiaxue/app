;~function () {

    var app = function () {
        this.id = api.pageParam.id;
        this.$thumb = $('[data-selector="thumb"]');
        this.$nav = $('[data-selector="nav-item"]');
        this.$title = $('[data-selector="title"]');
    };

    app.prototype.init = function () {
        var self = this;
        self.main();
    };
    /**
     * todo : 首页数据请求
     * @param callback
     */
    app.prototype.ajax = function (callback) {
        var self = this;
        callback = $.callback( callback );
        $.ajax({
            url : 'mall/shop/index',
            data : {
                shop_id : self.id
            }
        }).then( callback );
    };
    app.prototype.main = function () {
        var self = this;
        async.waterfall([
            function (cb) {
                self.ajax(cb);
            },
            function (ret , cb) {
                self.one(ret , cb);
            }
        ],function ( err ) {
            $.echo();
            self.switchPage();
            if(err) return $.api.toast(err);
        })
    };
    app.prototype.one = function (ret , callback) {
        var self = this;
        callback = $.callback(callback);
        self.$thumb.attr('data-echo-background' ,  ret.data.info.thumbs[0].path );
        self.$title.text(ret.data.info.name || '...');
        self.openPageGroup(ret);
        callback();
    };
    app.prototype.openPageGroup = function (ret) {
        var self = this;
        ret = $.extend({},ret.data,api.pageParam);
        api.openFrameGroup({
            name: 'beauty-home-group',
            background: '#ededed',
            scrollEnabled: true,
            rect: {
                x: 0,
                y: 48 + 90 + 45 + $.api.statusSize(),
                w: 'auto',
                h: 'auto'
            },
            index: 0,
            frames: [{
                name: 'beauty-home-index',
                url: 'widget://html/beauty/beauty-home-index.html',
                bgColor: '#ededed',
                pageParam : ret
            }, {
                name: 'beauty-home-service',
                url: 'widget://html/beauty/beauty-home-service.html',
                bgColor: '#ededed',
                pageParam : ret
            },{
                name: 'beauty-home-benefit',
                url: 'widget://html/beauty/beauty-home-benefit.html',
                bgColor: '#ededed',
                pageParam : ret
            }, {
                name: 'beauty-home-business',
                url: 'widget://html/beauty/beauty-home-business.html',
                bgColor: '#ededed',
                pageParam :ret
            }]
        }, function(ret, err) {
            self.$nav.removeClass('active').eq(ret.index).addClass('active');
        });
    };
    app.prototype.switchPage = function () {
        var self = this;
        self.$nav.on('tap' , function () {
            var i = $(this).index();
            $.api.switchPageIndex('beauty-home-group', i ,true);
        })
    };
    return $.beautyHome = function () {
        return new app();
    };
}();
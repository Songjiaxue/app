/**
 * Created by Administrator on 2016/8/26.
 */
;~function () {
    var app = function () {
        this.pullRefresh = $.pullRefresh();


        this.nav = $('.nav-item');
        this.navGroup = $('[data-selector="nav"]');
        this.title = $('[data-selector="title"]');
        //数据加载的选择器
        this._up_nav = $('[data-selector="up-nav-group"]');
        this.my_up_nav = $('[data-selector="my-up-nav-group"]');
        this.columnApi = 'bbs/Article/column';
        this.bbsPageGroup;
        //内容选择器
        this.officialContext = $('[data-selector="official-context"]');
        this.page = 1;
        this.size = 10;
        this.load = $('._load');
        this.loading = $('._loading');
        this._undefined = $('._undefined');
        //details
        this.detailsContext = $('[data-selector="details-context"]');
        this.assessContext = $('[data-selector="assess-context"]');
        //执行
    };
    /**
     * 官方热点论坛列表入口
     * @desc 配置了下拉刷新组件与入口数据操作
     * */
    app.prototype.init = function () {
        var self = this;
        self.refresh();
        self.officialMain();
    };

    /**
     * 配置下拉刷新，下拉刷新时，初始化page与加载更多的样式
     */
    app.prototype.refresh = function () {
        var self = this;
        self.pullRefresh.set(function () {
            //初始化
            self.page = 1;
            self.appendNotFind(true);
            //重新加载官方列表入口
            async.waterfall([
                function (cb) {
                    self.officialMain(cb);
                }
            ],function () {
                $.api.toast('刷新成功');
                //演示关闭下拉刷新，因为接口有点快
                setTimeout(function () {
                    api.refreshHeaderLoadDone();
                },500);
            });
        });
    };
    /**
     * 官方论坛列表数据入口
     * @desc 获取列表数据，如果不存在数据则打开无内容页面 根据page指数来判断是否是第一页
     * @param callback :function => 所有流程加载完毕的回调函数
     * */
    app.prototype.officialMain = function (callback) {
        var self = this;
        callback = typeof callback == 'function' ? callback : function () {};
        self.scrolltobottom(false);
        async.waterfall([
            function (cb) {
                self.getLists(cb);
            },
            function (ret,cb) {
                if(!( self.page - 1 ) ) return self.htmlOfficial(ret,cb);
                self.appendOfficial(ret,cb);
            }
        ],function (err,ret) {
            $.echo();
            callback();
            self.loading.hide();
            if(err) $.api.toast('error:' + err);
            if( typeof ret.data.info == 'undefined' || !ret.data.info.length ) return self.notFind();
            if( ret.data.info.length < self.size ) return self.appendNotFind();
            self.page += 1;
            self.scrolltobottom(true);
        });
    };
    /**
     * 获得官方列表数据
     * @param callback
     */
    app.prototype.getLists = function (callback) {
        var self = this;
        $.ajax({
            url : 'bbs/article/list',
            data : {
                page : self.page ,
                column_id : api.pageParam.id || 0 ,
                size : self.size || 10
            }
        }).then( callback );
    };
    app.prototype.bbsOfficialListsHtml = function ( db ) {
        db = db.data.info || [];
        var self = this,
            html = '';
        db.forEach(function (item , i) {
            html += '<div class="lists-item ';
            if(!!(self.page - 1))html += 'animated fadeIn';
            html += '" data-event="openNewWin" data-params=\'{"name":"';
            html += item.is_link ? 'win_url' : 'win_bbs_details';
            html += '","param":{"url":"';
            html += item.link;
            html += '","id":"';
            html += item.id;
            html += '","type":"official"}}\'><div class="lists-head"><div class="head" data-echo-background="';
            html += item.head || '../../images/img.png';
            html += '"></div><div class="nickname">';
            html += item.writer;
            html += '</div></div><div class="lists-img" data-echo-background="';
            html += item.thumb;
            html += '"></div><div class="lists-desc">';
            html += item.description;
            html += '</div><div class="lists-tools"><div class="tools-group"><div class="tools-item">';
            html += item.ago || '冰河世纪';
            html += '</div></div><div class="tools-group"><div class="tools-item"><div class="icon icon-share"></div></div><div class="tools-item ml15"><div class="icon icon-love "></div>';
            html += '<div class="pink">（';
            html += item.good || '0';
            html += '）</div></div></div></div><div class="lists-review">';
            html += '<div class="review-warp"><div class="review-icon icon-mes"></div><div class="review-context">';
            item.comment = item.comment || [];
            item.comment.forEach(function (comment) {
                html += '<div class="review-item">';
                html += comment.nick + ' : ' + comment.content;
                html += '</div> ';
            });
            html += '<div class="review-item">查看全部评论（';
            html += item.comment_count || '0';
            html += '）</div></div></div></div></div>';
        });
        return html;
    };
    app.prototype.appendOfficial = function (db,callback) {
        var self = this;
        self.officialContext.append( self.bbsOfficialListsHtml(db) );
        callback(null,db);
    };
    app.prototype.htmlOfficial = function (db,callback) {
        var self = this;
        self.officialContext.html( self.bbsOfficialListsHtml(db) );
        callback(null,db);
    };
    app.prototype.appendNotFind = function ($p) {
        if(!$p)return this.load.html('后面没有了');
        this.load.html('<i class="icon-spin3 animate-spin"></i>');
    };
    app.prototype.notFind = function () {
        this._undefined.show();
    };
    app.prototype.scrolltobottom = function ($f) {
        var self = this;
        if(!$f) return api.removeEventListener({
            name: 'scrolltobottom'
        });
        api.addEventListener({
            name:'scrolltobottom',
            extra:{
                threshold : 30            //设置距离底部多少距离时触发，默认值为0，数字类型
            }
        }, function(ret, err){
            self.officialMain();
        });
    };
    $.bbsOfficial = function () {
        return new app();
    }
}();